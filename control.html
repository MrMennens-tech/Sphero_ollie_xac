<!DOCTYPE html>
<html lang="nl" class="h-full bg-gray-900 text-white">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sphero Ollie Web + Gamepad Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: none;
        }
        #joystick-zone {
            position: relative;
            width: 250px;
            height: 250px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
        }
        .status-dot {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            display: inline-block;
            transition: background-color 0.3s ease;
        }
        .status-dot.disconnected { background-color: #ef4444; } /* red-500 */
        .status-dot.connected { background-color: #22c55e; } /* green-500 */
        .status-dot.connecting { background-color: #eab308; } /* yellow-500 */
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="h-full flex flex-col items-center justify-center p-4 space-y-6">

    <div class="text-center">
        <h1 class="text-4xl font-bold">Sphero Ollie Controller</h1>
        <p class="text-gray-400 mt-2">Bestuur je Ollie via het scherm of met een USB Gamepad.</p>
    </div>

    <!-- Status Indicators -->
    <div class="flex items-center space-x-8 bg-gray-800 p-4 rounded-lg">
        <div class="flex items-center space-x-3">
            <span id="ollie-status-dot" class="status-dot disconnected"></span>
            <span id="ollie-status" class="font-medium">Ollie: Niet verbonden</span>
        </div>
        <div class="flex items-center space-x-3">
            <span id="gamepad-status-dot" class="status-dot disconnected"></span>
            <span id="gamepad-status" class="font-medium">Gamepad: Niet verbonden</span>
        </div>
    </div>

    <!-- Main Controls -->
    <div class="flex flex-col md:flex-row items-center gap-8">
        <!-- On-screen Joystick -->
        <div class="flex flex-col items-center space-y-4">
             <h2 class="text-lg font-semibold">Scherm-joystick</h2>
            <div id="joystick-zone"></div>
        </div>

        <!-- Connection and Color Controls -->
        <div class="flex flex-col items-center space-y-4">
            <button id="connect-button" class="w-48 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105">
                Verbind met Ollie
            </button>
            <div class="flex flex-col items-center space-y-2">
                <label for="color-picker" class="font-semibold">Kies een kleur</label>
                <input type="color" id="color-picker" value="#00BFFF" class="w-24 h-12 p-1 bg-gray-800 rounded-lg cursor-pointer">
            </div>
        </div>
    </div>
    
    <!-- Instructions -->
    <div class="max-w-md text-center text-gray-400 text-sm p-4 bg-gray-800 rounded-lg">
        <h3 class="font-bold text-white mb-2">Instructies</h3>
        <p><span class="font-bold">1. Verbinden:</span> Klik op "Verbind met Ollie" en selecteer je robot in het Bluetooth-menu.</p>
        <p><span class="font-bold">2. Gamepad (Optioneel):</span> Sluit een USB-controller (zoals een Xbox controller) aan en druk op een knop om hem te activeren.</p>
        <p>De fysieke joystick heeft voorrang op de scherm-joystick.</p>
    </div>

    <script>
        const connectButton = document.getElementById('connect-button');
        const colorPicker = document.getElementById('color-picker');
        const joystickZone = document.getElementById('joystick-zone');
        const ollieStatus = document.getElementById('ollie-status');
        const ollieStatusDot = document.getElementById('ollie-status-dot');
        const gamepadStatus = document.getElementById('gamepad-status');
        const gamepadStatusDot = document.getElementById('gamepad-status-dot');

        // Based on https://github.com/binomed/sphero_ollie-web-bluetooth/blob/master/lib.js
        class Ollie {
            constructor() {
                this.device = null;
                this.services = {};
                this.characteristics = {};
                this.sequence = 0;
            }

            async connect() {
                try {
                    console.log('Requesting Bluetooth device...');
                    updateOllieStatus('Zoeken...', 'connecting');
                    this.device = await navigator.bluetooth.requestDevice({
                        filters: [{ namePrefix: 'Ollie' }],
                        optionalServices: [
                            '22bb746f-2bb0-7554-2d6f-726568705327', // Main service
                            '22bb746f-2bbf-7554-2d6f-726568705327'  // Anti-DOS service
                        ]
                    });
                    
                    this.device.addEventListener('gattserverdisconnected', () => this.onDisconnected());
                    
                    console.log('Connecting to GATT Server...');
                    updateOllieStatus('Verbinden...', 'connecting');
                    const server = await this.device.gatt.connect();

                    console.log('Getting services...');
                    const services = await server.getPrimaryServices();

                    for (const service of services) {
                        this.services[service.uuid] = service;
                        const characteristics = await service.getCharacteristics();
                        for (const characteristic of characteristics) {
                            this.characteristics[characteristic.uuid] = characteristic;
                        }
                    }

                    console.log('Ollie connected');
                    updateOllieStatus('Verbonden', 'connected');
                    await this.init();
                    return true;
                } catch (error) {
                    console.error('Connection failed:', error);
                    updateOllieStatus('Verbinding mislukt', 'disconnected');
                    return false;
                }
            }

            onDisconnected() {
                console.log('Ollie disconnected');
                updateOllieStatus('Niet verbonden', 'disconnected');
                this.device = null;
            }

            async init() {
                console.log('Initializing Ollie...');
                // Anti-DOS characteristic
                const useAntiDos = this.characteristics['22bb746f-2bbf-7554-2d6f-726568705327'];
                await useAntiDos.writeValue(new TextEncoder().encode('011i3'));
                
                // Wake up command
                await this.wake();
            }

            getNextSequence() {
                this.sequence = (this.sequence + 1) % 256;
                return this.sequence;
            }
            
            async sendCommand(did, cid, data = []) {
                if (!this.device || !this.device.gatt.connected) {
                    console.warn('Cannot send command, Ollie not connected.');
                    return;
                }

                const sequence = this.getNextSequence();
                const dataLength = data.length + 1;
                const checksum = (~((did + cid + sequence + dataLength + data.reduce((a, b) => a + b, 0)) & 0xFF)) & 0xFF;
                
                const command = new Uint8Array([0xFF, 0xFF, did, cid, sequence, dataLength, ...data, checksum]);
                
                try {
                    await this.characteristics['22bb746f-2bb2-7554-2d6f-726568705327'].writeValue(command);
                } catch (error) {
                    console.error('Error sending command:', error);
                }
            }

            async wake() {
                console.log('Waking Ollie...');
                await this.sendCommand(0x02, 0x30, [0x01]);
            }

            async setColor(r, g, b) {
                console.log(`Setting color to rgb(${r}, ${g}, ${b})`);
                await this.sendCommand(0x02, 0x20, [r, g, b, 0x01]);
            }
            
            async drive(speed, heading, state = 1) {
                let clampedSpeed = Math.max(0, Math.min(255, speed));
                let clampedHeading = Math.round(heading % 360);

                const headingHigh = clampedHeading >> 8;
                const headingLow = clampedHeading & 0xFF;
                
                await this.sendCommand(0x02, 0x30, [clampedSpeed, headingHigh, headingLow, state]);
            }
        }
        
        // --- Main Application Logic ---

        const ollie = new Ollie();
        let gamepadIndex = null;
        let lastGamepadMoveTime = 0;
        const GAMEPAD_TIMEOUT = 200; // ms to wait before stopping after last gamepad input
        let isDriving = false;

        function updateOllieStatus(text, statusClass) {
            ollieStatus.textContent = `Ollie: ${text}`;
            ollieStatusDot.className = `status-dot ${statusClass}`;
        }
        
        function updateGamepadStatus(text, statusClass) {
            gamepadStatus.textContent = `Gamepad: ${text}`;
            gamepadStatusDot.className = `status-dot ${statusClass}`;
        }

        // --- On-screen Joystick Setup ---
        const joystickManager = nipplejs.create({
            zone: joystickZone,
            mode: 'static',
            position: { left: '50%', top: '50%' },
            color: 'white',
            size: 150
        });

        joystickManager.on('move', (evt, data) => {
            if (!ollie.device || gamepadIndex !== null) return; // Gamepad takes priority
            
            const speed = Math.min(Math.floor(data.distance * 3), 255); // Scale distance to speed
            const heading = Math.round(data.angle.degree);
            
            ollie.drive(speed, heading);
            isDriving = true;
        });

        joystickManager.on('end', () => {
            if (!ollie.device || !isDriving) return;
            
            ollie.drive(0, 0); // Stop
            isDriving = false;
        });
        
        // --- Gamepad API Logic ---
        window.addEventListener('gamepadconnected', (e) => {
            console.log('Gamepad connected:', e.gamepad.id);
            gamepadIndex = e.gamepad.index;
            updateGamepadStatus('Verbonden', 'connected');
            gameLoop(); // Start the game loop
        });

        window.addEventListener('gamepaddisconnected', (e) => {
            console.log('Gamepad disconnected:', e.gamepad.id);
            if (gamepadIndex === e.gamepad.index) {
                gamepadIndex = null;
                updateGamepadStatus('Niet verbonden', 'disconnected');
            }
        });
        
        function gameLoop() {
            if (gamepadIndex === null) return; // Stop the loop if no gamepad
            
            const gp = navigator.getGamepads()[gamepadIndex];
            if (!gp) return;

            // Use left stick (axes 0 and 1)
            const x = gp.axes[0];
            const y = -gp.axes[1]; // Invert Y-axis for standard orientation
            
            const deadzone = 0.15;
            const magnitude = Math.sqrt(x * x + y * y);

            if (magnitude > deadzone) {
                lastGamepadMoveTime = Date.now();
                isDriving = true;

                // Calculate speed and heading
                const speed = Math.min(Math.floor(((magnitude - deadzone) / (1 - deadzone)) * 255), 255);
                let heading = Math.atan2(x, y) * (180 / Math.PI);
                if (heading < 0) {
                    heading += 360;
                }
                
                if (ollie.device) {
                    ollie.drive(speed, heading);
                }
            } else if (isDriving && (Date.now() - lastGamepadMoveTime > GAMEPAD_TIMEOUT)) {
                 // Stop the Ollie if joystick is centered and was moving
                 if (ollie.device) {
                    ollie.drive(0, 0);
                 }
                 isDriving = false;
            }

            requestAnimationFrame(gameLoop);
        }

        // --- Event Listeners ---
        connectButton.addEventListener('click', async () => {
            if (ollie.device) {
                ollie.device.gatt.disconnect();
            } else {
                await ollie.connect();
            }
        });

        colorPicker.addEventListener('input', (event) => {
            if (!ollie.device) return;

            const hex = event.target.value;
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            ollie.setColor(r, g, b);
        });

    </script>
</body>
</html>
